app:
  ~needs: [build-app]
  envFrom:
    - secretRef:
        name: app
  vars:
    NEXTAUTH_URL: https://{{ .Values.global.host }}
  probesPath: /healthz
  imagePackage: app

hasura:
  ~needs: [cnpg-cluster, build-hasura]
  vars:
    HASURA_GRAPHQL_CONSOLE_ASSETS_DIR: /srv/console-assets
  envFrom:
    - secretRef:
        name: hasura
    - secretRef:
        name: cnpg-cluster-app
    - configMapRef:
        name: hasura-configmap

cnpg-cluster:
  ~chart: pg

jobs:
  runs:
    build-app:
      use: build
      with:
        imagePackage: app
        buildArgs:
          NEXT_PUBLIC_HASURA_URL: "https://hasura-{{ .Values.global.host }}/v1/graphql"

    build-hasura:
      use: build
      with:
        imagePackage: hasura
        context: ./packages/hasura
        buildArgs:
          APP_URL: "https://{{ .Values.global.host }}"
